name: $(Date:yyyy).1$(DayOfYear)$(Rev:.r)

trigger:
- master

variables:
  VersionMajor: ''
  VersionMinor: ''
  VersionRevision: ''

pool:
  vmImage: 'windows-latest'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
    - job: BuildJob
      displayName: 'Build and Test assemblies'
      steps:
        - task: PowerShell@2
          displayName: Set the Major Version variable value
          inputs:
            targetType: 'inline'
            script: |
              [string] $version = $((Get-Date).Year)
              Write-Host "Setting the major version number variable to '$version'."
              Write-Host "##vso[task.setvariable variable=VersionMajor]$version"
        
        - task: PowerShell@2
          displayName: Set the Minor Version variable value
          inputs:
            targetType: 'inline'
            script: |
              [string] $version = "1$("{0:000}" -f (Get-Date).DayOfYear)"
              Write-Host "Setting the minor version number variable to '$version'."
              Write-Host "##vso[task.setvariable variable=VersionMinor]$version"

        - task: PowerShell@2
          displayName: Set the Revision Version variable value
          inputs:
            targetType: 'inline'
            script: |
              [string] $buildNumber = $Env:BUILD_BUILDNUMBER
              [string] $revision = $buildNumber.Substring($buildNumber.LastIndexOf('.') + 1)
              Write-Host "Setting the revision number variable to '$revision'."
              Write-Host "##vso[task.setvariable variable=VersionRevision]$revision"

        - task: NuGetToolInstaller@1
          displayName: 'Use NuGet 5.8.1'
          inputs:
            versionSpec: 5.8.1

        - task: DownloadSecureFile@1
          displayName: 'Download secure file'
          inputs:
            secureFile: 'i-synergy.pfx'

        - task: SonarCloudPrepare@1
          inputs:
            SonarCloud: 'SonarCloud'
            organization: 'i-synergy'
            scannerMode: 'MSBuild'
            projectKey: 'I-Synergy.Framework'
            projectName: 'I-Synergy.Framework'
            projectVersion: '$(VersionPackage)'
      
        - task: Assembly-Info-NetCore@2
          displayName: 'Set Assembly Manifest Data v2'
          inputs:
            FileNames: |
             src\ISynergy.Framework.Core\ISynergy.Framework.Core.csproj
             src\ISynergy.Framework.Core.Linq\ISynergy.Framework.Core.Linq.csproj
             src\ISynergy.Framework.AspNetCore\ISynergy.Framework.AspNetCore.csproj
             src\ISynergy.Framework.AspNetCore.Authentication\ISynergy.Framework.AspNetCore.Authentication.csproj
             src\ISynergy.Framework.EntityFramework\ISynergy.Framework.EntityFramework.csproj
             src\ISynergy.Framework.Financial\ISynergy.Framework.Financial.csproj
             src\ISynergy.Framework.Geography\ISynergy.Framework.Geography.csproj
             src\ISynergy.Framework.Mathematics\ISynergy.Framework.Mathematics.csproj
             src\ISynergy.Framework.MessageBus\ISynergy.Framework.MessageBus.csproj
             src\ISynergy.Framework.MessageBus.Azure\ISynergy.Framework.MessageBus.Azure.csproj
             src\ISynergy.Framework.Mvvm\ISynergy.Framework.Mvvm.csproj
             src\ISynergy.Framework.Storage\ISynergy.Framework.Storage.csproj
             src\ISynergy.Framework.Storage.Azure\ISynergy.Framework.Storage.Azure.csproj
             src\ISynergy.Framework.Payment\ISynergy.Framework.Payment.csproj
             src\ISynergy.Framework.Payment.Mollie\ISynergy.Framework.Payment.Mollie.csproj
             src\ISynergy.Framework.UI\ISynergy.Framework.UI.csproj
            InsertAttributes: true
            WriteBOM: true
            GeneratePackageOnBuild: true
            VersionNumber: '$(VersionNumber)'
            FileVersionNumber: '$(VersionFile)'
            InformationalVersion: '$(VersionInformational)'
            PackageVersion: '$(VersionPackage)'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Core'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Core\ISynergy.Framework.Core.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Core'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Core\ISynergy.Framework.Core.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Core.Linq'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Core.Linq\ISynergy.Framework.Core.Linq.csproj'
            arguments: '-c $(BuildConfiguration)'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Core'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Core\ISynergy.Framework.Core.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.AspNetCore'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.AspNetCore\ISynergy.Framework.AspNetCore.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.AspNetCore'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.AspNetCore\ISynergy.Framework.AspNetCore.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.AspNetCore.Authentication'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.AspNetCore.Authentication\ISynergy.Framework.AspNetCore.Authentication.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.AspNetCore.Authentication'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.AspNetCore.Authentication\ISynergy.Framework.AspNetCore.Authentication.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.EntityFramework'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.EntityFramework\ISynergy.Framework.EntityFramework.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.EntityFramework'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.EntityFramework\ISynergy.Framework.EntityFramework.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Financial'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Financial\ISynergy.Framework.Financial.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Financial'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Financial\ISynergy.Framework.Financial.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Geography'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Geography\ISynergy.Framework.Geography.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Geography'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Geography\ISynergy.Framework.Geography.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Mathematics'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Mathematics\ISynergy.Framework.Mathematics.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Mathematics'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Mathematics\ISynergy.Framework.Mathematics.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.MessageBus'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.MessageBus\ISynergy.Framework.MessageBus.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.MessageBus'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.MessageBus\ISynergy.Framework.MessageBus.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.MessageBus.Azure'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.MessageBus.Azure\ISynergy.Framework.MessageBus.Azure.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.MessageBus.Azure'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.MessageBus.Azure\ISynergy.Framework.MessageBus.Azure.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Mvvm'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Mvvm\ISynergy.Framework.Mvvm.csproj'
            arguments: '-c $(BuildConfiguration)'
      
        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Mvvm'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Mvvm\ISynergy.Framework.Mvvm.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Storage'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Storage\ISynergy.Framework.Storage.csproj'
            arguments: '-c $(BuildConfiguration)'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Storage'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Storage\ISynergy.Framework.Storage.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Storage.Azure'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Storage.Azure\ISynergy.Framework.Storage.Azure.csproj'
            arguments: '-c $(BuildConfiguration)'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Storage.Azure'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Storage.Azure\ISynergy.Framework.Storage.Azure.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Payment'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Payment\ISynergy.Framework.Payment.csproj'
            arguments: '-c $(BuildConfiguration)'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Payment'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Payment\ISynergy.Framework.Payment.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet build: I-Synergy.Framework.Payment.Mollie'
          inputs:
            command: build
            projects: 'src\ISynergy.Framework.Payment.Mollie\ISynergy.Framework.Payment.Mollie.csproj'
            arguments: '-c $(BuildConfiguration)'

        - task: DotNetCoreCLI@2
          displayName: 'Dotnet pack: I-Synergy.Framework.Payment.Mollie'
          inputs:
            command: 'pack'
            packagesToPack: 'src\ISynergy.Framework.Payment.Mollie\ISynergy.Framework.Payment.Mollie.csproj'
            nobuild: true
            includesymbols: true
            versioningScheme: 'byEnvVar'
            versionEnvVar: 'VersionPackage'

        - task: MSBuild@1
          displayName: 'Framework UI - Nuget Restore'
          inputs:
            solution: 'src\ISynergy.Framework.UI\ISynergy.Framework.UI.csproj'
            platform: AnyCpu
            configuration: '$(BuildConfiguration)'
            msbuildArguments: '/t:restore'

        - task: MSBuild@1
          displayName: 'Framework UI - Build and Pack'
          inputs:
            solution: 'src\ISynergy.Framework.UI\ISynergy.Framework.UI.csproj'
            platform: AnyCpu
            configuration: '$(BuildConfiguration)'
            msbuildArguments: '/p:PackageOutputPath=$(Build.ArtifactStagingDirectory)'
        
        - task: NuGetCommand@2
          displayName: 'Sign Nuget packages'
          inputs:
            command: 'custom'
            arguments: 'sign $(Build.ArtifactStagingDirectory)\*.nupkg -CertificatePath "$(Agent.WorkFolder)\_temp\i-synergy.pfx" -CertificatePassword "$(CertPassword)" -Timestamper "$(TimestampUrl)"'

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifacts'
          inputs:
            pathtoPublish: '$(Build.ArtifactStagingDirectory)'
            artifactName: Output
            publishLocation: 'Container'

        - task: DotNetCoreCLI@2
          displayName: 'Run Test: I-Synergy.Framework.Core'
          inputs:
            command: test
            projects: 'tests\ISynergy.Framework.Core.Tests\ISynergy.Framework.Core.Tests.csproj'
            arguments: '--configuration $(BuildConfiguration) --test-adapter-path:. --collect:"Code Coverage" --settings:codecoverage.runsettings'

        - task: DotNetCoreCLI@2
          displayName: 'Run Test: I-Synergy.Framework.Core.Linq'
          inputs:
            command: test
            projects: 'tests\ISynergy.Framework.Core.Linq.Tests\ISynergy.Framework.Core.Linq.Tests.csproj'
            arguments: '--configuration $(BuildConfiguration) --test-adapter-path:. --collect:"Code Coverage" --settings:codecoverage.runsettings'
      
        - task: DotNetCoreCLI@2
          displayName: 'Run Test: I-Synergy.Framework.AspNetCore'
          inputs:
            command: test
            projects: 'tests\ISynergy.Framework.AspNetCore.Tests\ISynergy.Framework.AspNetCore.Tests.csproj'
            arguments: '--configuration $(BuildConfiguration) --test-adapter-path:. --collect:"Code Coverage" --settings:codecoverage.runsettings'
      
        - task: DotNetCoreCLI@2
          displayName: 'Run Test: I-Synergy.Framework.Financial'
          inputs:
            command: test
            projects: 'tests\ISynergy.Framework.Financial.Tests\ISynergy.Framework.Financial.Tests.csproj'
            arguments: '--configuration $(BuildConfiguration) --test-adapter-path:. --collect:"Code Coverage" --settings:codecoverage.runsettings'
      
        - task: DotNetCoreCLI@2
          displayName: 'Run Test: I-Synergy.Framework.Geography'
          inputs:
            command: test
            projects: 'tests\ISynergy.Framework.Geography.Tests\ISynergy.Framework.Geography.Tests.csproj'
            arguments: '--configuration $(BuildConfiguration) --test-adapter-path:. --collect:"Code Coverage" --settings:codecoverage.runsettings'
      
        - task: DotNetCoreCLI@2
          displayName: 'Run Test: I-Synergy.Framework.Mathematics'
          inputs:
            command: test
            projects: 'tests\ISynergy.Framework.Mathematics.Tests\ISynergy.Framework.Mathematics.Tests.csproj'
            arguments: '--configuration $(BuildConfiguration) --test-adapter-path:. --collect:"Code Coverage" --settings:codecoverage.runsettings'

        - task: DotNetCoreCLI@2
          displayName: 'Run Test: I-Synergy.Framework.Payment'
          inputs:
            command: test
            projects: 'tests\ISynergy.Framework.Payment.Tests\ISynergy.Framework.Payment.Tests.csproj'
            arguments: '--configuration $(BuildConfiguration) --test-adapter-path:. --collect:"Code Coverage" --settings:codecoverage.runsettings'

        - task: SonarCloudAnalyze@1

  - stage: Release
    displayName: 'Release'
    dependsOn: Build
    condition: succeeded()
    jobs:
    - job: PackageJob
      displayName: 'Publish nuget packages'
      steps:
        - task: DownloadBuildArtifacts@0
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: 'Output'
            downloadPath: '$(System.ArtifactsDirectory)'

        - task: NuGetCommand@2
          displayName: 'NuGet push - I-Synergy.Framework'
          inputs:
            command: 'push'
            packagesToPush: '$(Build.ArtifactStagingDirectory)\Output\*.nupkg'
            nuGetFeedType: 'external'
            publishFeedCredentials: 'Nuget.org'

        - task: DocFxTask@0
          inputs:
            solution: 'docfx_project/docfx.json'

        - task: GitHubPagesPublish@1
          inputs:
            docPath: '$(System.DefaultWorkingDirectory)\docs\*'
            githubusername: 'I-Synergy'
            githubemail: 'ismail.hassani@i-synergy.nl'
            githubaccesstoken: '$(GithubPages)'
            repositoryname: 'I-Synergy.Framework'
            branchname: 'gh-pages'
            commitmessage: 'Automated Document Release $(build.buildNumber)'