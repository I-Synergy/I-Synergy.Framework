name: $(Date:yyyy).1$(Date:MMdd).1$(Date:HHmm)

trigger:
  branches:
    include:
    - main
  paths:
    exclude:
    - docs/*
    - '*.md'

pr:
  branches:
    include:
    - main
  paths:
    exclude:
    - docs/*
    - '*.md'

variables:
  - name: VersionNumber
    value: ''
  - name: VersionInformational  
    value: ''
  - name: VersionPackage
    value: ''

  - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
    - group: ACC
  - ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
    - group: PROD

pool:
  vmImage: 'windows-latest'

stages:
  - stage: BuildStage
    displayName: 'Build'
    jobs:
    - job: BuildJob
      displayName: 'Build, test and pack assemblies'
      timeoutInMinutes: 120
      steps:
        - task: PowerShell@2
          displayName: Set Version Variables
          inputs:
            targetType: 'filePath'
            filePath: '$(Build.SourcesDirectory)/scripts/Set-VersionVariables.ps1'
            arguments: '-BuildNumber "$(Build.BuildNumber)" -BuildReason "$(Build.Reason)"'

        - task: Assembly-Info-NetCore@3
          displayName: 'Set Release versions'
          inputs:
            FileNames: |
              src/**/*.csproj
              tests/**/*.csproj
            InsertAttributes: true
            WriteBOM: true
            VersionNumber: '$(VersionNumber)'
            FileVersionNumber: '$(VersionNumber)'
            InformationalVersion: '$(VersionInformational)'
            PackageVersion: '$(VersionPackage)'
            UpdateBuildNumber: '$(VersionPackage)'

        - task: NuGetToolInstaller@1
          displayName: 'Install NuGet 7.0.0'
          inputs:
            versionSpec: 7.0.0

        - task: UseDotNet@2
          displayName: 'Install .Net Sdk'
          inputs:
            packageType: 'sdk'
            useGlobalJson: true

        - task: DotNetCoreCLI@2
          displayName: 'Install MAUI workloads'
          inputs:
            command: custom
            custom: 'workload'
            arguments: 'install maui --source https://api.nuget.org/v3/index.json'

        - task: DownloadSecureFile@1
          displayName: 'Download secure file'
          inputs:
            secureFile: 'intelligence-online.pfx'

        - task: SonarCloudPrepare@3
          displayName: 'Prepare SonarCloud'
          inputs:
            SonarCloud: 'SonarCloud'
            organization: 'i-synergy'
            scannerMode: 'dotnet'
            projectKey: 'I-Synergy.Framework'
            projectName: 'I-Synergy.Framework'
            projectVersion: '$(VersionPackage)'

        - task: MSBuild@1
          displayName: 'Build I-Synergy Framework'
          inputs:
            solution: 'I-Synergy.Framework.slnx'
            msbuildArchitecture: 'x64'
            configuration: $(BuildConfiguration)
            msbuildArguments: '-p:Version=$(VersionPackage) -t:restore,build,pack -p:ContinuousIntegrationBuild=true /nr:false'

        - task: DotNetCoreCLI@2
          displayName: 'Test I-Synergy Framework'
          inputs:
            command: test
            projects: 'I-Synergy.Framework.slnx'
            arguments: '--configuration $(BuildConfiguration) --no-build --test-adapter-path:. --collect:"Code Coverage" --settings:codecoverage.runsettings'

        - task: CopyFiles@2
          displayName: 'Copy NuGet packages'
          inputs:
            SourceFolder: '$(Build.SourcesDirectory)\packages'
            Contents: '*'
            TargetFolder: '$(Build.ArtifactStagingDirectory)'

        - task: NuGetCommand@2
          displayName: 'Sign Nuget packages'
          inputs:
            command: 'custom'
            arguments: 'sign $(Build.ArtifactStagingDirectory)\*.nupkg -CertificatePath "$(Agent.WorkFolder)\_temp\intelligence-online.pfx" -CertificatePassword "$(CertPassword)" -Timestamper "$(TimestampUrl)"'

        - task: NuGetCommand@2
          displayName: 'Sign Nuget symbol packages'
          inputs:
            command: 'custom'
            arguments: 'sign $(Build.ArtifactStagingDirectory)\*.snupkg -CertificatePath "$(Agent.WorkFolder)\_temp\intelligence-online.pfx" -CertificatePassword "$(CertPassword)" -Timestamper "$(TimestampUrl)"'

        - task: PublishBuildArtifacts@1
          displayName: 'Publish Artifacts'
          inputs:
            pathtoPublish: '$(Build.ArtifactStagingDirectory)'
            artifactName: Output
            publishLocation: 'Container'

        - task: SonarCloudAnalyze@3
          displayName: 'Run SonarCloud analyzer'

        - task: SonarCloudPublish@3
          displayName: 'Publish SonarCloud analysis'
          inputs:
            pollingTimeoutSec: '300'

  - stage: Release
    displayName: 'Release'
    dependsOn: BuildStage
    condition: succeeded()
    jobs:
    - job: ArtifactsJob
      displayName: 'Get Nuget artifacts'
      steps:
        - task: DownloadPipelineArtifact@2
          inputs:
            artifact: 'Output'

    - deployment: DeployNuget
      displayName: 'Deploy to NuGet'
      environment: $(Environment)
      dependsOn: ArtifactsJob
      strategy:
        runOnce:
          deploy:
            steps:
              - task: NuGetToolInstaller@1
                displayName: 'Install NuGet 7.0.0'
                inputs:
                  versionSpec: 7.0.0

              - task: NuGetCommand@2
                displayName: 'NuGet push - ISynergy Framework'
                inputs:
                  command: 'push'
                  packagesToPush: '$(Pipeline.Workspace)/Output/*.nupkg'
                  nuGetFeedType: 'external'
                  publishFeedCredentials: 'Nuget.org'

    - job: GitHubReleaseJob
      displayName: 'Create GitHub Tag and Release'
      dependsOn: DeployNuget
      condition: succeeded('DeployNuget')
      steps:
        - checkout: self
          fetchDepth: 0
          persistCredentials: true

        - task: PowerShell@2
          displayName: 'Create Git Tag'
          inputs:
            targetType: 'inline'
            script: |
              $tag = "v$(VersionPackage)"
              $errorOccurred = $false
              $errorMessage = ""
              
              try {
                Write-Host "Checking if tag '$tag' already exists locally..."
                $localTagExists = & git rev-parse "$tag" 2>$null
                if ($LASTEXITCODE -eq 0) {
                  $errorMessage = "ERROR: Tag '$tag' already exists locally at commit: $localTagExists"
                  Write-Host "##vso[task.logissue type=error]$errorMessage"
                  $errorOccurred = $true
                }
                
                if (-not $errorOccurred) {
                  Write-Host "Checking if tag '$tag' exists on remote origin..."
                  $remoteTagExists = & git ls-remote --tags origin "$tag" 2>&1
                  if ($LASTEXITCODE -eq 0 -and $remoteTagExists) {
                    $errorMessage = "ERROR: Tag '$tag' already exists on remote. Remote refs: $remoteTagExists"
                    Write-Host "##vso[task.logissue type=error]$errorMessage"
                    $errorOccurred = $true
                  }
                }
                
                if (-not $errorOccurred) {
                  Write-Host "Configuring Git user for tag creation..."
                  $configEmailCmd = & git config user.email "azure-pipeline@i-synergy.com" 2>&1
                  if ($LASTEXITCODE -ne 0) { throw "Failed to configure git user.email: $configEmailCmd" }
                  $configNameCmd = & git config user.name "Azure Pipeline" 2>&1
                  if ($LASTEXITCODE -ne 0) { throw "Failed to configure git user.name: $configNameCmd" }
                  
                  Write-Host "Creating annotated tag '$tag'..."
                  $tagCreateOutput = & git tag -a "$tag" -m "Release $tag" $(Build.SourceVersion) 2>&1
                  if ($LASTEXITCODE -ne 0) { throw "Failed to create tag: $tagCreateOutput" }
                  
                  Write-Host "Tag created successfully. Pushing to origin..."
                  $pushOutput = & git push origin "$tag" 2>&1
                  if ($LASTEXITCODE -ne 0) {
                    $pushError = $pushOutput -join "`n"
                    if ($pushError -match "403|Permission|Forbidden|Unauthorized") {
                      $errorMessage = "AUTHENTICATION ERROR: Permission denied pushing to origin. Details: $pushError"
                    } elseif ($pushError -match "already exists|reject|update") {
                      $errorMessage = "COLLISION ERROR: Remote tag collision or update rejected. Details: $pushError"
                    } elseif ($pushError -match "Connection|timeout|unreachable|No route") {
                      $errorMessage = "NETWORK ERROR: Unable to connect to remote. Details: $pushError"
                    } else {
                      $errorMessage = "PUSH ERROR: Failed to push tag to origin. Details: $pushError"
                    }
                    Write-Host "##vso[task.logissue type=error]$errorMessage"
                    $errorOccurred = $true
                    Write-Host "Cleaning up local tag due to push failure..."
                    & git tag -d "$tag" 2>&1 | Out-Null
                  } else {
                    Write-Host "Tag '$tag' pushed to origin successfully."
                  }
                }
              } catch {
                $errorMessage = "EXCEPTION: $_"
                Write-Host "##vso[task.logissue type=error]$errorMessage"
                $errorOccurred = $true
              }
              
              if ($errorOccurred) {
                Write-Host "##vso[task.complete result=Failed;]"
                exit 1
              }
              
              Write-Host "Git tag operation completed successfully."
              exit 0

        - task: GitHubRelease@1
          displayName: 'Create GitHub Release'
          inputs:
            gitHubConnection: 'GitHub'
            repositoryName: '$(Build.Repository.Name)'
            action: 'create'
            target: '$(Build.SourceVersion)'
            tagSource: 'gitTag'
            tag: 'v$(VersionPackage)'
            changeLogCompareToRelease: 'lastRelease'
